<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŠì¢‹AI - Cross Verification System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'bounce-drop': 'bounce-drop 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards',
                        'tension-intro': 'tension-intro 0.8s ease-in-out infinite',
                        'wiggle-slow': 'wiggle 3s ease-in-out infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'float-slow': 'float 8s ease-in-out infinite',
                        'float-slower': 'float 10s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'fade-in-up': 'fadeInUp 0.6s ease-out forwards',
                    },
                    keyframes: {
                        wiggle: { '0%, 100%': { transform: 'rotate(-3deg)' }, '50%': { transform: 'rotate(3deg)' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;900&family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons (Vanilla JS Version) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Nunito', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        /* {% raw %} */
        const { useState, useEffect, useRef } = React;

        // --- [Fix: Lucide Icon Component for CDN] ---
        const Icon = ({ name, size = 24, className, color, ...props }) => {
            const ref = useRef(null);

            useEffect(() => {
                if (ref.current) {
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    ref.current.innerHTML = ''; 
                    ref.current.appendChild(i);

                    if (window.lucide) {
                        window.lucide.createIcons({
                            icons: { [name]: window.lucide.icons[name] },
                            nameAttr: 'data-lucide',
                            attrs: { 
                                class: className, 
                                width: size, 
                                height: size, 
                                stroke: color || "currentColor",
                                ...props
                            }
                        }, ref.current); 
                    }
                }
            }, [name, size, className, color, props]);

            return <span ref={ref} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        const iconNames = ['Send', 'Upload', 'Award', 'Terminal', 'CheckCircle2', 'XCircle', 'MessageSquare', 'FileText', 'X', 'HelpCircle', 'Folder', 'Plus', 'ChevronRight', 'ArrowLeft', 'Sparkles', 'RefreshCw', 'BookOpen', 'Package', 'ChevronDown', 'ChevronUp', 'Trophy'];
        const Icons = {};
        iconNames.forEach(name => {
            Icons[name] = (props) => <Icon name={name} {...props} />;
        });
        const { Send, Upload, Award, Terminal, CheckCircle2, XCircle, MessageSquare, FileText, X, HelpCircle, Folder, Plus, ChevronRight, ArrowLeft, Sparkles, RefreshCw, BookOpen, Package, ChevronDown, ChevronUp, Trophy } = Icons;
        const LucideIcon = ({ icon, ...props }) => <Icon name={icon} {...props} />;
        
        const useLucide = () => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, []);
        };

        // --- [Components] ---

        // [New Component] Confidence Bar (ì‹ ë¢°ë„ ê²Œì´ì§€ ë°”)
        const ConfidenceBar = ({ scores }) => {
            const { GPT, Gemini } = scores;
            const total = GPT + Gemini;
            // ì´ì ì´ 0ì´ë©´ 50:50ìœ¼ë¡œ í‘œì‹œ, ì•„ë‹ˆë©´ ë¹„ìœ¨ ê³„ì‚°
            const gptPercent = total === 0 ? 50 : (GPT / total) * 100;
            
            return (
                <div className="w-full px-6 pt-3 pb-1 bg-white z-10 flex flex-col gap-2">
                    <div className="flex justify-between items-center text-xs font-bold tracking-wider px-1">
                        <div className="flex items-center gap-1 text-blue-600">
                            <LucideIcon icon="Trophy" size={12} />
                            ChatGPT: <span className="text-sm">{GPT}</span>
                        </div>
                        <div className="text-gray-300 text-[10px]">TRUST SCORE</div>
                        <div className="flex items-center gap-1 text-orange-600">
                            <span className="text-sm">{Gemini}</span> : Gemini
                            <LucideIcon icon="Trophy" size={12} />
                        </div>
                    </div>
                    
                    <div className="relative w-full h-3 bg-gray-100 rounded-full overflow-hidden flex shadow-inner border border-gray-200">
                        {/* ChatGPT Bar (Blue) */}
                        <div 
                            className="h-full bg-gradient-to-r from-blue-400 to-blue-600 transition-all duration-700 ease-out relative" 
                            style={{ width: `${gptPercent}%` }}
                        >
                            {/* Glare effect */}
                            <div className="absolute top-0 left-0 w-full h-[50%] bg-white opacity-20"></div>
                        </div>
                        
                        {/* Center Marker (VS) */}
                        <div className="absolute left-1/2 top-0 bottom-0 w-0.5 bg-white z-10 opacity-50 mix-blend-overlay"></div>

                        {/* Gemini Bar (Orange) */}
                        <div 
                            className="h-full bg-gradient-to-l from-orange-400 to-orange-600 transition-all duration-700 ease-out relative" 
                            style={{ width: `${100 - gptPercent}%` }}
                        >
                             {/* Glare effect */}
                             <div className="absolute top-0 left-0 w-full h-[50%] bg-white opacity-20"></div>
                        </div>
                    </div>
                </div>
            );
        };

        const DetailedPixelCharacter = ({ variant, is_winner, is_loser, scale = 1 }) => {
        return (
            <svg 
            viewBox="0 0 32 32" 
            className={`drop-shadow-md transition-transform duration-500 ${is_winner ? 'animate-bounce scale-110' : ''} ${is_loser ? 'opacity-50 rotate-12 grayscale-[0.5]' : ''}`} 
            style={{
                imageRendering: 'pixelated',
                width: `${24 * scale}px`, 
                height: `${24 * scale}px`
            }}
            >
            <rect x="10" y="30" width="12" height="2" fill="#000000" opacity="0.2" />
            {variant === 'original' ? (
                <g>
                    <rect x="0" y="0" width="32" height="32" fill="none" />
                    <rect x="6" y="5" width="20" height="6" fill="#43A047" /> 
                    <rect x="4" y="9" width="24" height="3" fill="#43A047" /> 
                    <rect x="4" y="10" width="24" height="1" fill="#2E7D32" opacity="0.3" /> 
                    <rect x="12" y="6" width="8" height="4" fill="#FFFFFF" /> 
                    <path d="M14 7 V10 H17" stroke="#43A047" strokeWidth="1" fill="none" /> 
                    <rect x="5" y="12" width="22" height="10" fill="#FFFFFF" /> 
                    <rect x="5" y="9" width="2" height="3" fill="#FFFFFF" />
                    <rect x="25" y="9" width="2" height="3" fill="#FFFFFF" />
                    <rect x="9" y="15" width="2" height="3" fill="#000000" />
                    <rect x="21" y="15" width="2" height="3" fill="#000000" />
                    <rect x="14" y="17" width="4" height="2" fill="#FFEB3B" />
                    <rect x="4" y="14" width="2" height="1" fill="#000000" />
                    <rect x="4" y="17" width="2" height="1" fill="#000000" />
                    <rect x="26" y="14" width="2" height="1" fill="#000000" />
                    <rect x="26" y="17" width="2" height="1" fill="#000000" />
                    <rect x="7" y="17" width="3" height="2" fill="#F48FB1" opacity="0.7" />
                    <rect x="22" y="17" width="3" height="2" fill="#F48FB1" opacity="0.7" />
                    <rect x="8" y="22" width="16" height="6" fill="#43A047" /> 
                    <rect x="10" y="22" width="12" height="6" fill="#1E88E5" /> 
                    <rect x="10" y="28" width="4" height="2" fill="#1E88E5" /> 
                    <rect x="18" y="28" width="4" height="2" fill="#1E88E5" /> 
                    <rect x="11" y="23" width="2" height="2" fill="#FFEB3B" />
                    <rect x="19" y="23" width="2" height="2" fill="#FFEB3B" />
                    <rect x="8" y="30" width="5" height="2" fill="#795548" />
                    <rect x="19" y="30" width="5" height="2" fill="#795548" />
                    <rect x="7" y="24" width="2" height="3" fill="#FFFFFF" />
                    <rect x="23" y="24" width="2" height="3" fill="#FFFFFF" />
                </g>
            ) : (
                <g>
                    <rect x="0" y="0" width="32" height="32" fill="none" />
                    <rect x="6" y="6" width="20" height="6" fill="#E53935" /> 
                    <rect x="4" y="9" width="24" height="3" fill="#E53935" /> 
                    <rect x="12" y="7" width="8" height="4" fill="#FFFFFF" /> 
                    <path d="M14 7 V10 M14 7 L16 9 L18 7 M18 7 V10" stroke="#E53935" strokeWidth="1" fill="none" /> 
                    <rect x="5" y="12" width="22" height="10" fill="#FFFFFF" /> 
                    <rect x="5" y="9" width="2" height="3" fill="#FFFFFF" />
                    <rect x="25" y="9" width="2" height="3" fill="#FFFFFF" />
                    <rect x="9" y="15" width="2" height="3" fill="#000000" />
                    <rect x="21" y="15" width="2" height="3" fill="#000000" />
                    <rect x="14" y="17" width="4" height="2" fill="#FFEB3B" />
                    <rect x="4" y="14" width="2" height="1" fill="#000000" />
                    <rect x="4" y="17" width="2" height="1" fill="#000000" />
                    <rect x="26" y="14" width="2" height="1" fill="#000000" />
                    <rect x="26" y="17" width="2" height="1" fill="#000000" />
                    <rect x="7" y="17" width="3" height="2" fill="#F48FB1" opacity="0.6" />
                    <rect x="22" y="17" width="3" height="2" fill="#F48FB1" opacity="0.6" />
                    <rect x="8" y="22" width="16" height="6" fill="#E53935" /> 
                    <rect x="10" y="22" width="12" height="6" fill="#1E88E5" /> 
                    <rect x="10" y="28" width="4" height="2" fill="#1E88E5" /> 
                    <rect x="18" y="28" width="4" height="2" fill="#1E88E5" /> 
                    <rect x="11" y="23" width="2" height="2" fill="#FFEB3B" />
                    <rect x="19" y="23" width="2" height="2" fill="#FFEB3B" />
                    <rect x="8" y="30" width="5" height="2" fill="#795548" />
                    <rect x="19" y="30" width="5" height="2" fill="#795548" />
                    <rect x="7" y="24" width="2" height="3" fill="#FFFFFF" />
                    <rect x="23" y="24" width="2" height="3" fill="#FFFFFF" />
                </g>
            )}
            </svg>
        );
        };

        const RopeSvg = ({ slack, width = 200 }) => {
        const start_y = 20;
        const mid_x = width / 2;
        return (
            <svg width={width} height="60" className="absolute overflow-visible z-0" style={{ left: '50%', transform: 'translateX(-50%)', bottom: '18px' }}>
            <path d={`M 0 ${start_y} Q ${mid_x} ${start_y + slack + 2} ${width} ${start_y}`} stroke="rgba(0,0,0,0.2)" strokeWidth="3" fill="none" />
            <path d={`M 0 ${start_y} Q ${mid_x} ${start_y + slack} ${width} ${start_y}`} stroke="#D7CCC8" strokeWidth="3" fill="none" strokeLinecap="round"/>
            <path d={`M 0 ${start_y} Q ${mid_x} ${start_y + slack} ${width} ${start_y}`} stroke="#8D6E63" strokeWidth="1" strokeDasharray="3 3" fill="none" opacity="0.5"/>
            <g style={{ transform: `translate(${mid_x}px, ${start_y + slack * 0.7}px)` }}> 
                <rect x="-1.5" y="-2" width="3" height="6" fill="#B71C1C" /> 
                <path d="M 0 0 L 0 20" stroke="#D32F2F" strokeWidth="1.5" /> 
                <path d="M 0 20 L 10 24 L 0 28 Z" fill="#E53935" /> 
            </g>
            </svg>
        );
        };

        const PixelCloud = ({ className, style }) => (
        <svg viewBox="0 0 24 12" className={className} style={{...style, imageRendering: 'pixelated'}}>
            <rect x="4" y="4" width="16" height="8" fill="white" />
            <rect x="8" y="2" width="8" height="2" fill="white" />
            <rect x="2" y="6" width="2" height="4" fill="white" />
            <rect x="20" y="6" width="2" height="4" fill="white" />
            <path d="M4 12 H20 M20 10 V12 M4 10 V12 M2 6 H4 M20 6 H22 M22 6 V10 M2 6 V10 M8 2 H16 M16 2 V4 M8 2 V4" stroke="#333" strokeWidth="0.5" fill="none" opacity="0.1"/>
        </svg>
        );

        const GroundDecoration = () => {
        const items = [
            { type: 'grass', left: '10%', color: '#00a800' },
            { type: 'flower', left: '25%', color: '#f8d800' }, 
            { type: 'grass', left: '40%', color: '#00a800' },
            { type: 'flower', left: '65%', color: '#e40058' }, 
            { type: 'grass', left: '85%', color: '#00a800' },
        ];
        return (
            <>
            {items.map((item, idx) => (
                <div key={idx} className="absolute bottom-full mb-[-2px]" style={{ left: item.left }}>
                {item.type === 'grass' ? <div className="w-2 h-2 bg-[#00a800] rounded-t-sm" /> : 
                    <svg width="10" height="12" viewBox="0 0 10 12" className="animate-wiggle-slow">
                    <rect x="4" y="6" width="2" height="6" fill="#00a800" />
                    <circle cx="5" cy="4" r="3" fill={item.color} />
                    <circle cx="5" cy="4" r="1" fill="white" />
                    </svg>}
                </div>
            ))}
            </>
        );
        };

        const IntroAnimation = ({ on_complete }) => {
        const [visible, set_visible] = useState(true);
        const letters = ['G', 'e', 'm', 'P', 'T']; 

        useEffect(() => {
            const animation_end_time = 4000; 
            const hold_time = 2000;         
            const fade_out_duration = 800;   

            const fade_timer = setTimeout(() => {
            set_visible(false); 
            }, animation_end_time + hold_time);

            const complete_timer = setTimeout(() => {
            on_complete();
            }, animation_end_time + hold_time + fade_out_duration);

            return () => {
            clearTimeout(fade_timer);
            clearTimeout(complete_timer);
            };
        }, [on_complete]);

        return (
            <div className={`fixed inset-0 z-50 flex flex-col bg-[#5c94fc] transition-opacity duration-[800ms] ease-out ${!visible ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}>
            <div className="flex-1 relative overflow-hidden">
                <PixelCloud className="absolute top-10 left-10 w-24 h-12 opacity-90 animate-float-slow" />
                <PixelCloud className="absolute top-20 right-20 w-32 h-16 opacity-90 animate-float-slower" />
                <PixelCloud className="absolute top-40 left-1/3 w-20 h-10 opacity-80 animate-float" />

                <div className="absolute inset-0 flex items-center justify-center pb-32">
                <div className="flex gap-3">
                    {letters.map((char, idx) => (
                    <span 
                        key={idx}
                        className="text-8xl font-black text-white drop-shadow-[4px_4px_0_rgba(0,0,0,0.2)] animate-bounce-drop inline-block opacity-0"
                        style={{ 
                        animationDelay: `${idx * 0.8}s`, 
                        fontFamily: '"Press Start 2P", "Nunito", sans-serif',
                        textShadow: '4px 4px 0 #3b82f6'
                        }}
                    >
                        {char}
                    </span>
                    ))}
                </div>
                </div>
                
                <div className="absolute bottom-40 w-full text-center">
                <p className="text-white font-bold tracking-widest uppercase text-lg animate-pulse opacity-0" style={{animation: 'fadeIn 1s ease-out 4.5s forwards'}}>
                    Credit Verification System
                </p>
                </div>
            </div>

            <div className="h-[16vh] w-full bg-[#c84c0c] relative flex justify-center items-end border-t-4 border-black/20">
                <div className="absolute inset-0 opacity-20" style={{backgroundImage: 'linear-gradient(335deg, rgba(0,0,0,0.3) 23px, transparent 23px), linear-gradient(155deg, rgba(0,0,0,0.3) 23px, transparent 23px), linear-gradient(335deg, rgba(0,0,0,0.3) 23px, transparent 23px), linear-gradient(155deg, rgba(0,0,0,0.3) 23px, transparent 23px)', backgroundSize: '58px 58px', backgroundPosition: '0px 2px, 4px 35px, 2px 31px, 34px 6px'}}></div>
                <GroundDecoration />

                <div className="mb-4 relative w-full max-w-md h-20 overflow-visible">
                <div className="absolute bottom-0 left-0 w-full h-full animate-tension-intro">
                    <div className="absolute bottom-0 left-0 w-full flex justify-center">
                        <RopeSvg slack={10} width={260} />
                    </div>
                    <div className="absolute bottom-0 left-10" style={{ transform: 'rotate(-5deg)' }}>
                        <DetailedPixelCharacter variant="modified" scale={2.5} />
                    </div>
                    <div className="absolute bottom-0 right-10" style={{ transform: 'rotate(5deg)' }}>
                        <DetailedPixelCharacter variant="original" scale={2.5} />
                    </div>
                </div>
                </div>
            </div>

            <style>{`
                @keyframes bounce-drop {
                0% { transform: translateY(-600px); opacity: 0; }
                60% { transform: translateY(30px); opacity: 1; }
                80% { transform: translateY(-10px); opacity: 1; }
                100% { transform: translateY(0); opacity: 1; }
                }
                @keyframes tension-intro {
                0%, 100% { transform: translateX(0px); }
                25% { transform: translateX(-20px); }
                75% { transform: translateX(20px); }
                }
                .animate-bounce-drop { animation: bounce-drop 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
                .animate-tension-intro { animation: tension-intro 0.8s ease-in-out infinite; }
                @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
            `}</style>
            </div>
        );
        };

        // TugOfWarScene: ì¤„ë‹¤ë¦¬ê¸° ì• ë‹ˆë©”ì´ì…˜
        const TugOfWarScene = ({ state, winner }) => {
            const is_loading = state === 'loading';
            const is_finished = state === 'finished';
            
            const gpt_win = is_finished && winner === 'GPT';
            const gemini_win = is_finished && winner === 'Gemini';
            const [slack, set_slack] = useState(20);

            useEffect(() => {
                if (is_loading) {
                    const interval = setInterval(() => set_slack(prev => (prev === 20 ? 5 : 20)), 600);
                    return () => clearInterval(interval);
                } else {
                    set_slack(10); 
                }
            }, [is_loading]);

            // Animation Class Logic
            // If loading: 'animate-tension'
            // If finished: Move to winner side (no animation loop)
            const containerClass = `absolute bottom-0 left-0 w-full h-full transition-transform duration-1000 ease-in-out 
                ${is_loading ? 'animate-tension' : (gpt_win ? 'translate-x-[-100px]' : gemini_win ? 'translate-x-[100px]' : '')}`;

            return (
                <div className="fixed inset-x-0 bottom-0 h-48 flex justify-center items-end pointer-events-none z-30 animate-fade-in">
                    <div className="relative w-full max-w-lg h-full">
                        <div className={containerClass}>
                            <div className="absolute bottom-0 left-0 w-full flex justify-center">
                                <RopeSvg slack={slack} width={300} />
                            </div>

                            <div className="absolute bottom-4 left-0" style={{ transform: 'rotate(-5deg)' }}>
                                <div className={`bg-white/90 px-3 py-1 rounded-lg text-xs font-black text-blue-700 mb-2 border-2 border-blue-200 shadow-sm text-center absolute -top-10 left-1/2 -translate-x-1/2 whitespace-nowrap transition-opacity duration-500 ${gpt_win ? 'opacity-100 scale-110' : 'opacity-80'}`}>
                                ChatGPT {gpt_win && "ğŸ‘‘"}
                                </div>
                                <DetailedPixelCharacter variant="modified" is_winner={gpt_win} is_loser={gemini_win} scale={3} />
                            </div>

                            <div className="absolute bottom-4 right-0" style={{ transform: 'rotate(5deg)' }}>
                                <div className={`bg-white/90 px-3 py-1 rounded-lg text-xs font-black text-orange-600 mb-2 border-2 border-orange-200 shadow-sm text-center absolute -top-10 left-1/2 -translate-x-1/2 whitespace-nowrap transition-opacity duration-500 ${gemini_win ? 'opacity-100 scale-110' : 'opacity-80'}`}>
                                Gemini {gemini_win && "ğŸ‘‘"}
                                </div>
                                <DetailedPixelCharacter variant="original" is_winner={gemini_win} is_loser={gpt_win} scale={3} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ProcessModal = ({ logs, on_close }) => {
            useLucide();
        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
            <div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
                <div className="bg-gray-100 px-4 py-3 border-b flex justify-between items-center">
                <h3 className="font-bold text-gray-700 flex items-center gap-2"><LucideIcon icon="Terminal" size={16} /> ê²€ì¦ ê³¼ì • ë¡œê·¸</h3>
                <button onClick={on_close} className="p-1 rounded-full hover:bg-gray-200 transition-colors"><LucideIcon icon="X" size={20} className="text-gray-500" /></button>
                </div>
                <div className="p-4 overflow-y-auto bg-gray-50 scrollbar-hide">
                {logs.length === 0 ? <p className="text-center text-gray-400 text-sm py-4">ê¸°ë¡ëœ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p> : logs.map((log, index) => <ChatBubble key={index} log={log} />)}
                </div>
            </div>
            </div>
        );
        };

        const ChatBubble = ({ log }) => {
            const [isOpen, setIsOpen] = useState(false);
            const is_gpt = log.sender === "GPT";
            const is_user = log.sender === "User";
            const is_system = log.sender === "System";
            
            // Special handling for Knowledge steps
            const is_knowledge_collection = log.step === "ì§€ì‹ ìˆ˜ì§‘";
            const is_knowledge_package = log.step === "ì§€ì‹ íŒ¨í‚¤ì§€ ìƒì„±";

            if (is_user) return null;

            // Dropdown UI for Knowledge steps
            if (is_knowledge_collection || is_knowledge_package) {
                // Try to pretty print JSON for knowledge package
                let content = log.message;
                if (is_knowledge_package) {
                    try {
                        const parsed = JSON.parse(log.message);
                        content = JSON.stringify(parsed, null, 2);
                    } catch (e) {
                        // keep original if parse fails
                    }
                }

                return (
                    <div className="flex flex-col w-full mb-3">
                        <button 
                            onClick={() => setIsOpen(!isOpen)}
                            className="flex items-center justify-between w-full p-3 bg-white border border-gray-200 rounded-lg shadow-sm hover:bg-gray-50 transition-colors text-left"
                        >
                            <div className="flex items-center gap-2 text-sm font-bold text-gray-700">
                                {is_knowledge_collection ? <LucideIcon icon="BookOpen" size={16} className="text-blue-500"/> : <LucideIcon icon="Package" size={16} className="text-purple-500"/>}
                                {is_knowledge_collection ? "ì§€ì‹ ìˆ˜ì§‘ ë°ì´í„°" : "ìƒì„±ëœ ì§€ì‹ íŒ¨í‚¤ì§€"}
                            </div>
                            <LucideIcon icon={isOpen ? "ChevronUp" : "ChevronDown"} size={16} className="text-gray-400" />
                        </button>
                        
                        {isOpen && (
                            <div className="mt-2 p-4 bg-gray-50 rounded-lg border border-gray-200 text-xs font-mono whitespace-pre-wrap text-gray-600 overflow-x-auto animate-fade-in">
                                {content}
                            </div>
                        )}
                    </div>
                );
            }

            if (is_system) return <div className="flex justify-center my-3"><div className="bg-gray-200 text-gray-600 text-[10px] py-1 px-3 rounded-full flex items-center gap-1 font-mono border border-gray-300"><LucideIcon icon="Terminal" size={10} />{log.message}</div></div>;
            
            return (
                <div className={`flex w-full mb-3 ${is_gpt ? 'justify-start' : 'justify-end'}`}>
                <div className={`max-w-[85%] p-3 rounded-2xl shadow-sm border ${is_gpt ? 'bg-blue-50 border-blue-100 rounded-tl-none text-blue-900' : 'bg-purple-50 border-purple-100 rounded-tr-none text-purple-900'}`}>
                    <div className="flex items-center gap-2 mb-1 text-xs font-bold opacity-70">{is_gpt ? <LucideIcon icon="MessageSquare" size={12} /> : <LucideIcon icon="CheckCircle2" size={12} />}{log.sender}</div>
                    <div className="text-xs whitespace-pre-wrap leading-relaxed">{log.message}</div>
                </div>
                </div>
            );
        };

        // --- [Refactored Result Content (Inline)] ---
        const ResultContent = ({ result, on_show_process }) => {
            if (!result) return null;
            return (
                <div className="w-full bg-gradient-to-br from-white/80 to-white/50 backdrop-blur-sm border border-indigo-100 rounded-2xl p-6 shadow-sm animate-fade-in-up">
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-2"><LucideIcon icon="Award" className="text-yellow-500" size={24} /><h2 className="text-xl font-bold text-gray-800">ê²€ì¦ ê²°ê³¼</h2></div>
                        <button onClick={on_show_process} className="flex items-center gap-1 px-3 py-1.5 bg-white border border-indigo-200 text-indigo-600 text-xs font-bold rounded-full hover:bg-indigo-50 transition-all shadow-sm"><LucideIcon icon="FileText" size={12} />ìƒì„¸ í’€ì´</button>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div className="bg-white/80 p-3 rounded-lg border border-gray-100 text-center shadow-sm"><p className="text-xs text-gray-400 mb-1">ìµœì¢… ìŠ¹ì</p><p className="text-lg font-bold text-indigo-600">{result.winner}</p></div>
                        <div className="bg-white/80 p-3 rounded-lg border border-gray-100 text-center shadow-sm"><p className="text-xs text-gray-400 mb-1">íšë“ ì ìˆ˜</p><p className="text-lg font-bold text-green-600">{result.winner === 'GPT' ? `+${result.scores?.GPT || 0}` : `+${result.scores?.Gemini || 0}`} Point</p></div>
                    </div>

                    <div className="bg-white rounded-lg border border-indigo-100 p-4 shadow-sm">
                        <h3 className="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><LucideIcon icon="CheckCircle2" size={16} className="text-green-500" />ìµœì¢… ì •ë‹µ</h3>
                        <p className="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">{result.final_answer}</p>
                    </div>
                </div>
            );
        };

        const CloudCardBackground = ({ children, onClick, className }) => {
        return (
            <div onClick={onClick} className={`relative p-8 flex flex-col items-center justify-center min-h-[180px] transition-transform hover:scale-105 cursor-pointer group ${className}`}>
            <svg className="absolute inset-0 w-full h-full drop-shadow-xl" viewBox="0 0 200 150" preserveAspectRatio="none" style={{imageRendering: 'pixelated'}}>
                <path fill="#000" d="M40 10 H90 V20 H110 V10 H160 V30 H180 V80 H160 V100 H110 V90 H90 V100 H40 V80 H20 V30 H40 Z" transform="scale(1.02) translate(-2, -2)" />
                <path fill="#FFF" d="M40 10 H90 V20 H110 V10 H160 V30 H180 V80 H160 V100 H110 V90 H90 V100 H40 V80 H20 V30 H40 Z" />
            </svg>
            <div className="relative z-10 w-full h-full flex flex-col gap-2">
                {children}
            </div>
            </div>
        )
        }

        const ProjectCard = ({ id, title, date, on_click }) => (
        <CloudCardBackground onClick={on_click}>
            <div className="flex items-start justify-between w-full mb-2">
            <h3 className="font-bold text-gray-800 text-2xl leading-tight line-clamp-2 text-left">
                {title}
            </h3>
            <div className="text-xs text-gray-500 font-mono whitespace-nowrap ml-2 mt-1">{date}</div>
            </div>
            <div className="mt-auto w-full flex items-center justify-end text-white text-xs font-bold gap-1 opacity-0 group-hover:opacity-100 transition-opacity drop-shadow-md">
            ì…ì¥í•˜ê¸° <LucideIcon icon="ChevronRight" size={14} />
            </div>
        </CloudCardBackground>
        );

        const NewProjectCard = ({ on_create }) => (
        <CloudCardBackground onClick={on_create} className="opacity-90 hover:opacity-100">
            <div className="flex flex-col items-center justify-center h-full gap-1 text-gray-500 group-hover:text-blue-600 mb-10"> 
                <LucideIcon icon="Plus" size={20} />
                <span className="font-bold text-base">ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±</span>
            </div>
        </CloudCardBackground>
        );

        // --- [Main App Component] ---

        function App() {
        useLucide();
        const [view, set_view] = useState('intro');
        const [projects, set_projects] = useState([]);
        const [current_project, set_current_project] = useState(null);

        const [input, set_input] = useState("");
        const [image, set_image] = useState(null); 
        const [imageFile, set_imageFile] = useState(null); 

        const [logs, set_logs] = useState([]);
        const [is_loading, set_is_loading] = useState(false); 
        const [result, set_result] = useState(null);
        const [scores, set_scores] = useState({ GPT: 0, Gemini: 0 });
        const [is_modal_open, set_is_modal_open] = useState(false);
        const [process_started, set_process_started] = useState(false);
        
        const [is_create_modal_open, set_is_create_modal_open] = useState(false);
        const [new_project_title, set_new_project_title] = useState("");

        const scrollRef = useRef(null);

        const handle_intro_complete = () => { set_view('projectList'); };

        const open_create_modal = () => {
            set_new_project_title(""); 
            set_is_create_modal_open(true);
        };

        const handle_create_project_submit = (e) => {
            e.preventDefault();
            if (!new_project_title.trim()) return;

            const new_project = { 
            project_id: `proj_${Date.now()}`, 
            id: Date.now(), 
            title: new_project_title, 
            date: new_project_title ? new Date().toLocaleDateString() : new Date().toLocaleDateString(),
            logs: [], 
            result: null 
            };
            
            set_projects([new_project, ...projects]);
            set_is_create_modal_open(false);
        };

        const enter_project = (project) => {
            set_current_project(project);
            set_logs([]); set_result(null); set_process_started(false); set_input(""); set_image(null); set_imageFile(null);
            set_view('chat');
        };
        
        const back_to_projects = () => { set_view('projectList'); set_current_project(null); };
        
        const handle_image_upload = (e) => { 
            const file = e.target.files[0];
            if (file) {
                set_image(URL.createObjectURL(file)); 
                set_imageFile(file);
            }
        };

        // Auto scroll to bottom when result or logs update
        useEffect(() => {
            if (scrollRef.current) {
                scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
            }
        }, [logs, result, is_loading]);

        const handle_submit = async (e) => {
            e.preventDefault();
            if (!input.trim() && !imageFile) return;
            
            set_process_started(true); 
            set_is_loading(true); 
            set_result(null); 
            set_logs([]); 
            
            try {
                const formData = new FormData();
                formData.append('question', input);
                if (imageFile) {
                    formData.append('image', imageFile);
                }

                const response = await fetch('/api/solve', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Backend error: ${response.statusText}`);
                }

                const final_result = await response.json();

                if (final_result.process && Array.isArray(final_result.process)) {
                    for (const process_step of final_result.process) {
                        const log_entry = {
                            step: process_step.step || 0,
                            sender: process_step.model, 
                            message: process_step.content 
                        };
                        
                        set_logs(prev => [...prev, log_entry]);
                        await new Promise(r => setTimeout(r, 800));
                    }
                }

                set_scores(final_result.scores);
                set_result(final_result);

            } catch (error) { 
                console.error("Error:", error); 
                set_logs(prev => [...prev, { step: 999, sender: "System", message: `ì˜¤ë¥˜ ë°œìƒ: ${error.message}` }]);
            } finally { 
                set_is_loading(false); 
            }
        };
        
        return (
            <>
            {view === 'intro' && <IntroAnimation on_complete={handle_intro_complete} />}

            {(view === 'projectList' || view === 'chat') && (
                <div className="min-h-screen bg-[#5c94fc] flex flex-col items-center font-sans relative overflow-hidden">
                
                <div className="absolute inset-0 pointer-events-none">
                    <PixelCloud className="absolute top-10 left-10 w-24 h-12 opacity-60" />
                    <PixelCloud className="absolute top-20 right-20 w-32 h-16 opacity-60" />
                    <PixelCloud className="absolute top-40 left-1/3 w-20 h-10 opacity-50" />
                </div>
                <div className="absolute bottom-0 w-full h-[16vh] bg-[#c84c0c] border-t-4 border-black/20 pointer-events-none z-0">
                    <div className="absolute inset-0 opacity-20" style={{backgroundImage: 'linear-gradient(335deg, rgba(0,0,0,0.3) 23px, transparent 23px), linear-gradient(155deg, rgba(0,0,0,0.3) 23px, transparent 23px), linear-gradient(335deg, rgba(0,0,0,0.3) 23px, transparent 23px), linear-gradient(155deg, rgba(0,0,0,0.3) 23px, transparent 23px)', backgroundSize: '58px 58px', backgroundPosition: '0px 2px, 4px 35px, 2px 31px, 34px 6px'}}></div>
                    <GroundDecoration />
                </div>

                {view === 'projectList' && (
                    <div className="z-10 w-full max-w-4xl px-6 py-12 flex flex-col h-screen">
                    <div className="flex items-center gap-3 mb-8 animate-fade-in-up">
                        <div className="w-12 h-12 bg-white rounded-2xl shadow-lg flex items-center justify-center text-2xl font-black text-blue-600">G</div>
                        <div><h1 className="text-3xl font-black text-white drop-shadow-md">ë‚´ í”„ë¡œì íŠ¸</h1><p className="text-blue-100 text-sm">ì§„í–‰ ì¤‘ì¸ ê²€ì¦ ì‘ì—…ì„ ê´€ë¦¬í•˜ì„¸ìš”</p></div>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 overflow-y-auto pb-20 scrollbar-hide animate-fade-in-up delay-100">
                        <NewProjectCard on_create={open_create_modal} />
                        {projects.map((project) => <ProjectCard key={project.id} {...project} on_click={() => enter_project(project)} />)}
                    </div>
                    
                    {is_create_modal_open && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in">
                        <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden flex flex-col">
                            <div className="bg-gray-100 px-4 py-3 border-b flex justify-between items-center">
                            <h3 className="font-bold text-gray-700 flex items-center gap-2"><LucideIcon icon="Plus" size={16} /> ìƒˆ í”„ë¡œì íŠ¸</h3>
                            <button onClick={() => set_is_create_modal_open(false)} className="p-1 rounded-full hover:bg-gray-200 transition-colors"><LucideIcon icon="X" size={20} className="text-gray-500" /></button>
                            </div>
                            <form onSubmit={handle_create_project_submit} className="p-5 flex flex-col gap-4">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">í”„ë¡œì íŠ¸ ì´ë¦„</label>
                                <input 
                                type="text" 
                                value={new_project_title} 
                                onChange={(e) => set_new_project_title(e.target.value)} 
                                placeholder="ì˜ˆ: AIì˜ ë¯¸ë˜ì— ëŒ€í•œ í† ë¡ " 
                                className="w-full bg-gray-50 text-gray-800 border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all text-sm"
                                autoFocus
                                />
                            </div>
                            <button type="submit" disabled={!new_project_title.trim()} className={`w-full py-2 rounded-lg font-bold text-sm text-white shadow-md transition-all ${!new_project_title.trim() ? 'bg-gray-300 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 hover:scale-105'}`}>
                                ìƒì„±í•˜ê¸°
                            </button>
                            </form>
                        </div>
                        </div>
                    )}
                    </div>
                )}

                {view === 'chat' && (
                    <div className="w-full h-full flex flex-col items-center relative">
                    <button onClick={back_to_projects} className="absolute top-4 left-4 sm:top-8 sm:left-8 z-50 bg-white/90 hover:bg-white px-4 py-2 rounded-full shadow-lg transition-all hover:scale-105 text-gray-700 font-bold text-sm flex items-center gap-2 border border-gray-200">
                        <LucideIcon icon="ArrowLeft" size={18} />
                        <span className="hidden sm:inline">ëª©ë¡ìœ¼ë¡œ</span>
                    </button>
                    {is_modal_open && <ProcessModal logs={logs.filter(log => log.sender !== 'User')} on_close={() => set_is_modal_open(false)} />}
                    
                    {process_started && (
                        <TugOfWarScene state={is_loading ? 'loading' : 'finished'} winner={result?.winner} />
                    )}

                    {/* [UI ìˆ˜ì •] ì§ˆë¬¸ì°½ í¬ê¸° í™•ëŒ€ (max-w-2xl -> max-w-4xl, h-[50vh] -> h-[65vh]) */}
                    <div className="w-full max-w-4xl bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col h-[65vh] mt-20 z-20 relative animate-fade-in-up mx-4">
                        <div className="bg-white border-b px-6 py-4 flex items-center justify-between z-10 shadow-sm">
                            <div className="flex items-center gap-2"><div className="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg flex items-center justify-center text-white font-bold">G</div><h1 className="text-xl font-bold text-gray-800 truncate max-w-[200px] sm:max-w-md">{current_project?.title}</h1></div>
                            <div className="flex items-center gap-3">
                                <div className="text-xs text-gray-400 flex items-center gap-1"><span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>Online</div>
                                {!is_loading && result && (
                                    <button onClick={() => { set_process_started(false); set_result(null); set_input(""); set_image(null); set_imageFile(null); }} className="text-xs font-bold text-gray-500 hover:text-indigo-600 flex items-center gap-1"><LucideIcon icon="RefreshCw" size={12} /> ì²˜ìŒìœ¼ë¡œ</button>
                                )}
                            </div>
                        </div>
                        
                        {/* Scrollable Content Area */}
                        <div className="flex-1 overflow-y-auto bg-gray-50 p-6 space-y-6" ref={scrollRef}>
                            {process_started ? (
                                <>
                                    {/* User Question Bubble */}
                                    <div className="flex justify-end">
                                        <div className="bg-indigo-600 text-white rounded-2xl rounded-tr-none px-5 py-3 max-w-[80%] shadow-md">
                                            {image && <img src={image} alt="User upload" className="mb-2 rounded-lg max-h-40 object-cover border border-indigo-400" />}
                                            <p className="text-sm leading-relaxed whitespace-pre-wrap">{input || (image ? "ì´ë¯¸ì§€ ë¶„ì„ ìš”ì²­" : "")}</p>
                                        </div>
                                    </div>

                                    {/* Loading State */}
                                    {is_loading && (
                                        <div className="flex justify-start animate-fade-in">
                                            <div className="bg-white border border-indigo-100 rounded-2xl rounded-tl-none px-5 py-4 shadow-sm flex flex-col items-center gap-3 min-w-[200px]">
                                                <LucideIcon icon="Award" size={32} className="text-indigo-400 animate-bounce" />
                                                <p className="text-xs font-bold text-indigo-400 animate-pulse">AIë“¤ì´ ì¹˜ì—´í•˜ê²Œ ê²€ì¦ ì¤‘ì…ë‹ˆë‹¤...</p>
                                            </div>
                                        </div>
                                    )}

                                    {/* [UI ìˆ˜ì •] ê²°ê³¼ ì¹´ë“œê°€ ì´ì œ ì±„íŒ…ì°½ ì•ˆì— ìì—°ìŠ¤ëŸ½ê²Œ í‘œì‹œë¨ */}
                                    {result && (
                                        <div className="flex justify-start w-full">
                                           <ResultContent result={result} on_show_process={() => set_is_modal_open(true)} />
                                        </div>
                                    )}
                                </>
                            ) : (
                                <div className="h-full flex flex-col items-center justify-center text-gray-300 space-y-4">
                                    <LucideIcon icon="Award" size={64} className="opacity-20" />
                                    <p className="text-base text-center font-medium text-gray-400">ì§ˆë¬¸ì„ ì…ë ¥í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì—¬<br/>ë‘ AIì˜ ì‹ ë¢°ë„ ê²½ìŸì„ ì‹œì‘í•˜ì„¸ìš”.</p>
                                </div>
                            )}
                        </div>

                        {/* Input Area */}
                        <div className="bg-white border-t z-10">
                            <ConfidenceBar scores={scores} />
                            <div className="p-4 pt-2">
                                {image && !process_started && <div className="flex items-center gap-2 mb-2 p-2 bg-gray-50 rounded-lg w-fit"><img src={image} alt="Preview" className="w-10 h-10 object-cover rounded-md" /><span className="text-xs text-gray-500">ì´ë¯¸ì§€ ì²¨ë¶€ë¨</span><button onClick={() => {set_image(null); set_imageFile(null);}} className="text-gray-400 hover:text-red-500"><LucideIcon icon="XCircle" size={16} /></button></div>}
                                <form onSubmit={handle_submit} className="flex items-center gap-2">
                                    <label className={`cursor-pointer p-3 transition-colors rounded-full ${is_loading ? 'text-gray-200 cursor-not-allowed' : 'text-gray-400 hover:text-indigo-500 hover:bg-indigo-50'}`}><LucideIcon icon="Upload" size={20} /><input type="file" accept="image/*" className="hidden" onChange={handle_image_upload} disabled={is_loading} /></label>
                                    <input type="text" value={input} onChange={(e) => set_input(e.target.value)} placeholder={process_started ? "ê²€ì¦ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤..." : "ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."} className="flex-1 bg-gray-100 text-gray-800 placeholder-gray-400 px-4 py-3 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled={is_loading} />
                                    <button type="submit" disabled={is_loading || (!input && !image)} className={`p-3 rounded-full text-white shadow-md transition-all ${is_loading || (!input && !image) ? 'bg-gray-300 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 hover:scale-105'}`}><LucideIcon icon="Send" size={20} /></button>
                                </form>
                            </div>
                        </div>
                    </div>
                    </div>
                )}
                </div>
            )}
            <style>{`
                @keyframes tension { 0%, 100% { transform: translateX(0px); } 25% { transform: translateX(-20px); } 75% { transform: translateX(20px); } }
                .animate-tension { animation: tension 0.5s ease-in-out infinite; }
                .animate-float-slow { animation: float 6s ease-in-out infinite; }
                @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
            `}</style>
            </>
        );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
        /* {% endraw %} */
    </script>
</body>
</html>